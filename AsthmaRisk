/* Generate data for U01 prediction model
This code identifies children with an asmtha-related claim in 2014.
It then brings in 2015 claims to look at risk factors for asmtha-related hospital or ED visit

APDE, PHSKC
Lin Song
2016-05-26
*/

use PHClaims
-- select * from information_schema.columns --Shows the variable types

--Generate data for U01 prediction model

--1. select children with asthma and age 3-17 (born between 1997-2011) in 2014
--#A1. Select needed baseline fields, age, and sequence the entries by eligiblity dates
DROP TABLE #A1
SELECT CAL_YEAR AS YEAR, MEDICAID_RECIPIENT_ID AS ID2014, GENDER, RACE1, HISPANIC_ORIGIN_NAME AS HISP, BIRTH_DATE AS DOB,
CTZNSHP_STATUS_NAME AS CTZNSHP, INS_STATUS_NAME AS INS_STATUS, SPOKEN_LNG_NAME AS LANG, FPL_PRCNTG AS FPL, RAC_CODE,
FROM_DATE, TO_DATE, END_REASON, COVERAGE_TYPE_IND AS COVERAGE, POSTAL_CODE AS ZIPCODE,
ROW_NUMBER() OVER(PARTITION BY MEDICAID_RECIPIENT_ID ORDER BY MEDICAID_RECIPIENT_ID, FROM_DATE DESC, TO_DATE DESC) AS ROW
INTO #A1
FROM PHClaims.dbo.vEligibility
WHERE CAL_YEAR=2014 AND BIRTH_DATE BETWEEN '1997-01-01' AND '2011-12-31';

--#A2. Select the last entry in 2014
DROP #A2.
SELECT * INTO #A2 FROM #A1 WHERE ROW=1;

--#A3. Select children in the following year to be matched with baseline
DROP TABLE #A3
SELECT DISTINCT MEDICAID_RECIPIENT_ID AS ID2015
INTO #A3
FROM PHClaims.dbo.vEligibility
WHERE CAL_YEAR=2015 AND BIRTH_DATE BETWEEN '1997-01-01' AND '2011-12-31'
GROUP BY MEDICAID_RECIPIENT_ID;

--#A4. Match baseline with the following year (only include cases present in both years)
DROP TABLE #A4
SELECT * INTO #A4
FROM #A2
INNER JOIN #A3
ON #A2.ID2014=#A3.ID2015;

ALTER TABLE #A4
DROP COLUMN ID2015

SELECT ID2014 INTO #A5 FROM #A4
SELECT * FROM #A5



--#T1=number of baseline total hospitalizations
DROP TABLE #T1
SELECT DISTINCT MEDICAID_RECIPIENT_ID AS ID2014, COUNT(DISTINCT FROM_SRVC_DATE) AS T1 INTO #T1
FROM PHClaims.dbo.vClaims
WHERE CAL_YEAR=2014 AND CLM_TYPE_CID=31
GROUP BY MEDICAID_RECIPIENT_ID;

--#T2=number of baseline total ED visits
DROP TABLE #T2
SELECT DISTINCT MEDICAID_RECIPIENT_ID AS ID2014, COUNT(DISTINCT FROM_SRVC_DATE) AS T2 INTO #T2
FROM PHClaims.dbo.vClaims
WHERE CAL_YEAR=2014 AND REVENUE_CODE IN ('0450','0456','0459','0981')
GROUP BY MEDICAID_RECIPIENT_ID;


--#B. SELECT 2014 BASELINE CLAIMS DATA FOR PATIENTS WITH ASTHMA
DROP TABLE #B
SELECT * INTO #B
FROM PHClaims.dbo.vClaims
INNER JOIN #A5
ON PHClaims.dbo.vClaims.MEDICAID_RECIPIENT_ID=#A5.ID2014
WHERE CAL_YEAR=2014
AND (PRIMARY_DIAGNOSIS_CODE LIKE '493%' OR PRIMARY_DIAGNOSIS_CODE LIKE 'J45%'
OR DIAGNOSIS_CODE_2 LIKE '493%' OR DIAGNOSIS_CODE_2 LIKE 'J45%'
OR DIAGNOSIS_CODE_3 LIKE '493%' OR DIAGNOSIS_CODE_3 LIKE 'J45%'
OR DIAGNOSIS_CODE_4 LIKE '493%' OR DIAGNOSIS_CODE_4 LIKE 'J45%'
OR DIAGNOSIS_CODE_5 LIKE '493%' OR DIAGNOSIS_CODE_5 LIKE 'J45%');

--Generate predictors from #B, such as hospitalization, ED visit, urgent care visit, other visit type? comorbidity?
--#B1=number of baseline hospitalizations for asthma, any diagnosis
SELECT DISTINCT ID2014, COUNT(DISTINCT FROM_SRVC_DATE) AS H1 INTO #B1
FROM #B
WHERE CAL_YEAR=2014 AND CLM_TYPE_CID=31
AND (PRIMARY_DIAGNOSIS_CODE LIKE '493%' OR PRIMARY_DIAGNOSIS_CODE LIKE 'J45%'
OR DIAGNOSIS_CODE_2 LIKE '493%' OR DIAGNOSIS_CODE_2 LIKE 'J45%'
OR DIAGNOSIS_CODE_3 LIKE '493%' OR DIAGNOSIS_CODE_3 LIKE 'J45%'
OR DIAGNOSIS_CODE_4 LIKE '493%' OR DIAGNOSIS_CODE_4 LIKE 'J45%'
OR DIAGNOSIS_CODE_5 LIKE '493%' OR DIAGNOSIS_CODE_5 LIKE 'J45%')
GROUP BY ID2014;

--#B2=number of baseline hospitalizations for asthma, primary diagnosis
DROP TABLE #B2
SELECT DISTINCT ID2014, COUNT(DISTINCT FROM_SRVC_DATE) AS H2 INTO #B2
FROM #B
WHERE CAL_YEAR=2014 AND CLM_TYPE_CID=31
AND (PRIMARY_DIAGNOSIS_CODE LIKE '493%' OR PRIMARY_DIAGNOSIS_CODE LIKE 'J45%')
GROUP BY ID2014;

--#B3=number of ER visit for asthma, any diagnosis
SELECT DISTINCT ID2014, COUNT(DISTINCT FROM_SRVC_DATE) AS E1 INTO #B3	
FROM #B
WHERE CAL_YEAR=2014 AND REVENUE_CODE IN ('0450','0456','0459','0981')
AND (PRIMARY_DIAGNOSIS_CODE LIKE '493%' OR PRIMARY_DIAGNOSIS_CODE LIKE 'J45%'
OR DIAGNOSIS_CODE_2 LIKE '493%' OR DIAGNOSIS_CODE_2 LIKE 'J45%'
OR DIAGNOSIS_CODE_3 LIKE '493%' OR DIAGNOSIS_CODE_3 LIKE 'J45%'
OR DIAGNOSIS_CODE_4 LIKE '493%' OR DIAGNOSIS_CODE_4 LIKE 'J45%'
OR DIAGNOSIS_CODE_5 LIKE '493%' OR DIAGNOSIS_CODE_5 LIKE 'J45%')
GROUP BY ID2014;

DROP TABLE #B4
--#B4=number of ER visit for asthma, primary diagnosis
SELECT DISTINCT ID2014, COUNT(DISTINCT FROM_SRVC_DATE) AS E2 INTO #B4	
FROM #B
WHERE CAL_YEAR=2014 AND REVENUE_CODE IN ('0450','0456','0459','0981')
AND (PRIMARY_DIAGNOSIS_CODE LIKE '493%' OR PRIMARY_DIAGNOSIS_CODE LIKE 'J45%')
GROUP BY ID2014;


DROP TABLE #B5
--#B5=well child check up visit for asthma, any diagnosis
SELECT DISTINCT ID2014, COUNT(DISTINCT FROM_SRVC_DATE) AS C1 INTO #B5	
FROM #B
WHERE CAL_YEAR=2014 AND CLM_TYPE_CID=27
AND (PRIMARY_DIAGNOSIS_CODE LIKE '493%' OR PRIMARY_DIAGNOSIS_CODE LIKE 'J45%'
OR DIAGNOSIS_CODE_2 LIKE '493%' OR DIAGNOSIS_CODE_2 LIKE 'J45%'
OR DIAGNOSIS_CODE_3 LIKE '493%' OR DIAGNOSIS_CODE_3 LIKE 'J45%'
OR DIAGNOSIS_CODE_4 LIKE '493%' OR DIAGNOSIS_CODE_4 LIKE 'J45%'
OR DIAGNOSIS_CODE_5 LIKE '493%' OR DIAGNOSIS_CODE_5 LIKE 'J45%')
GROUP BY ID2014;

--#B6=number of well child checkup visit for asthma, primary diagnosis
DROP TABLE #B6
SELECT DISTINCT ID2014, COUNT(DISTINCT FROM_SRVC_DATE) AS C2 INTO #B6	
FROM #B
WHERE CAL_YEAR=2014 AND CLM_TYPE_CID=27
AND (PRIMARY_DIAGNOSIS_CODE LIKE '493%' OR PRIMARY_DIAGNOSIS_CODE LIKE 'J45%')
GROUP BY ID2014;

--#B7=number of asthma-related claims, any diagnosis
SELECT DISTINCT ID2014, COUNT(DISTINCT TCN) AS A1 INTO #B7	
FROM #B
WHERE CAL_YEAR=2014
AND (PRIMARY_DIAGNOSIS_CODE LIKE '493%' OR PRIMARY_DIAGNOSIS_CODE LIKE 'J45%'
OR DIAGNOSIS_CODE_2 LIKE '493%' OR DIAGNOSIS_CODE_2 LIKE 'J45%'
OR DIAGNOSIS_CODE_3 LIKE '493%' OR DIAGNOSIS_CODE_3 LIKE 'J45%'
OR DIAGNOSIS_CODE_4 LIKE '493%' OR DIAGNOSIS_CODE_4 LIKE 'J45%'
OR DIAGNOSIS_CODE_5 LIKE '493%' OR DIAGNOSIS_CODE_5 LIKE 'J45%')
GROUP BY ID2014;

--#B8=number of asthma-related claims, primary diagnosis
DROP TABLE #B8
SELECT DISTINCT ID2014, COUNT(DISTINCT TCN) AS A2 INTO #B8	
FROM #B
WHERE CAL_YEAR=2014
AND (PRIMARY_DIAGNOSIS_CODE LIKE '493%' OR PRIMARY_DIAGNOSIS_CODE LIKE 'J45%')
GROUP BY ID2014;

---------------------------
--#C. SELECT 2015 (SUBSEQUENT YEAR) CLAIMS DATA FOR PATIENTS WITH ASTHMA
DROP TABLE #C
SELECT * INTO #C
FROM PHClaims.dbo.vClaims
INNER JOIN #A5
ON PHClaims.dbo.vClaims.MEDICAID_RECIPIENT_ID=#A5.ID2014
WHERE CAL_YEAR=2015
AND (PRIMARY_DIAGNOSIS_CODE LIKE '493%' OR PRIMARY_DIAGNOSIS_CODE LIKE 'J45%'
OR DIAGNOSIS_CODE_2 LIKE '493%' OR DIAGNOSIS_CODE_2 LIKE 'J45%'
OR DIAGNOSIS_CODE_3 LIKE '493%' OR DIAGNOSIS_CODE_3 LIKE 'J45%'
OR DIAGNOSIS_CODE_4 LIKE '493%' OR DIAGNOSIS_CODE_4 LIKE 'J45%'
OR DIAGNOSIS_CODE_5 LIKE '493%' OR DIAGNOSIS_CODE_5 LIKE 'J45%');

--Generate outcome variables from #C, such as hospitalization, ED visit, 
--#C1=number of hospitalizations for asthma, any diagnosis, OUTCOME VARIABLE
DROP TABLE #C1
SELECT DISTINCT ID2014, COUNT(DISTINCT FROM_SRVC_DATE) AS EX_H1 INTO #C1
FROM #C
WHERE CAL_YEAR=2015 AND CLM_TYPE_CID=31
AND (PRIMARY_DIAGNOSIS_CODE LIKE '493%' OR PRIMARY_DIAGNOSIS_CODE LIKE 'J45%'
OR DIAGNOSIS_CODE_2 LIKE '493%' OR DIAGNOSIS_CODE_2 LIKE 'J45%'
OR DIAGNOSIS_CODE_3 LIKE '493%' OR DIAGNOSIS_CODE_3 LIKE 'J45%'
OR DIAGNOSIS_CODE_4 LIKE '493%' OR DIAGNOSIS_CODE_4 LIKE 'J45%'
OR DIAGNOSIS_CODE_5 LIKE '493%' OR DIAGNOSIS_CODE_5 LIKE 'J45%')
GROUP BY ID2014;

--#C2=number of EXIT hospitalizations for asthma, primary diagnosis
DROP TABLE #C2
SELECT DISTINCT ID2014, COUNT(DISTINCT FROM_SRVC_DATE) AS EX_H2 INTO #C2
FROM #C
WHERE CAL_YEAR=2015 AND CLM_TYPE_CID=31
AND (PRIMARY_DIAGNOSIS_CODE LIKE '493%' OR PRIMARY_DIAGNOSIS_CODE LIKE 'J45%')
GROUP BY ID2014;

--#C3=number of EXIT ER visit for asthma, any diagnosis
DROP TABLE #C3
SELECT DISTINCT ID2014, COUNT(DISTINCT FROM_SRVC_DATE) AS EX_E1 INTO #C3	
FROM #C
WHERE CAL_YEAR=2015 AND REVENUE_CODE IN ('0450','0456','0459','0981')
AND (PRIMARY_DIAGNOSIS_CODE LIKE '493%' OR PRIMARY_DIAGNOSIS_CODE LIKE 'J45%'
OR DIAGNOSIS_CODE_2 LIKE '493%' OR DIAGNOSIS_CODE_2 LIKE 'J45%'
OR DIAGNOSIS_CODE_3 LIKE '493%' OR DIAGNOSIS_CODE_3 LIKE 'J45%'
OR DIAGNOSIS_CODE_4 LIKE '493%' OR DIAGNOSIS_CODE_4 LIKE 'J45%'
OR DIAGNOSIS_CODE_5 LIKE '493%' OR DIAGNOSIS_CODE_5 LIKE 'J45%')
GROUP BY ID2014;

DROP TABLE #C4
--#C4=number of EXIT ER visit for asthma, primary diagnosis
SELECT DISTINCT ID2014, COUNT(DISTINCT FROM_SRVC_DATE) AS EX_E2 INTO #C4	
FROM #C
WHERE CAL_YEAR=2015 AND REVENUE_CODE IN ('0450','0456','0459','0981')
AND (PRIMARY_DIAGNOSIS_CODE LIKE '493%' OR PRIMARY_DIAGNOSIS_CODE LIKE 'J45%')
GROUP BY ID2014;

SELECT * FROM #B1

----xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
/*Join files */
SELECT #A5.ID2014,
#T1.T1,
#T2.T2,
#B7.A1,
#B8.A2,
#B1.H1,
#B2.H2,
#B3.E1,
#B4.E2,
#B5.C1,
#B6.C2,
#C1.EX_H1,
#C2.EX_H2,
#C3.EX_E1,
#C4.EX_E2
INTO #D1
FROM #A5
INNER JOIN #B7
ON #A5.ID2014=#B7.ID2014
LEFT JOIN #B8
ON #A5.ID2014=#B8.ID2014
LEFT JOIN #B1
ON #A5.ID2014=#B1.ID2014
LEFT JOIN #B2
ON #A5.ID2014=#B2.ID2014
LEFT JOIN #B3
ON #A5.ID2014=#B3.ID2014
LEFT JOIN #B4
ON #A5.ID2014=#B4.ID2014
LEFT JOIN #B5
ON #A5.ID2014=#B5.ID2014
LEFT JOIN #B6
ON #A5.ID2014=#B6.ID2014
LEFT JOIN #C1
ON #A5.ID2014=#C1.ID2014
LEFT JOIN #C2
ON #A5.ID2014=#C2.ID2014
LEFT JOIN #C3
ON #A5.ID2014=#C3.ID2014
LEFT JOIN #C4
ON #A5.ID2014=#C4.ID2014
LEFT JOIN #T1
ON #A5.ID2014=#T1.ID2014
LEFT JOIN #T2
ON #A5.ID2014=#T2.ID2014;



SELECT * FROM #D1

SELECT * FROM #A4
INNER JOIN #D1
ON #A4.ID2014=#D1.ID2014;

